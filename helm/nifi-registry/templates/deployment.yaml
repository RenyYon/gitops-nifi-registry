apiVersion: apps/v1
kind: Deployment
metadata:
  name: nifi-registry
spec:
  replicas: 1
  selector:
    matchLabels:
      app: nifi-registry
  template:
    metadata:
      labels:
        app: nifi-registry
    spec:
      initContainers:
        - name: download-jdbc
          image: curlimages/curl:8.6.0
          command:
            - sh
            - -c
            - >
              mkdir -p /opt/nifi-registry/nifi-registry-current/lib/ext &&
              curl -fL
              https://repo1.maven.org/maven2/org/postgresql/postgresql/42.7.9/postgresql-42.7.9.jar
              -o /opt/nifi-registry/nifi-registry-current/lib/ext/postgresql.jar
          volumeMounts:
            - name: registry-lib-ext
              mountPath: /opt/nifi-registry/nifi-registry-current/lib/ext

      containers:
        - name: nifi-registry
          image: "apache/nifi-registry:2.6.0"
          imagePullPolicy: IfNotPresent
          command:
            - sh
            - -c
            - >
              /opt/nifi-registry/nifi-registry-current/bin/nifi-registry.sh start &&
              tail -f /opt/nifi-registry/nifi-registry-current/logs/nifi-registry-app.log
          ports:
            - containerPort: 18080
          envFrom:
            - secretRef:
                name: nifi-registry-db
          resources:
            limits:
              cpu: 2
              memory: 2Gi
            requests:
              cpu: 500m
              memory: 768Mi
          volumeMounts:
            - name: registry-lib-ext
              mountPath: /opt/nifi-registry/nifi-registry-current/lib/ext

      volumes:
        - name: registry-lib-ext
          emptyDir: {}
